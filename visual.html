<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Enhanced Groundwater API Tester</title>
	<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
	<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
	<script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
	<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
	<style>
		body { 
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
			margin: 0; 
			padding: 20px;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
		}
		.container {
			max-width: 1400px;
			margin: 0 auto;
		}
		input, button, select, textarea { 
			font-size: 14px; 
			padding: 10px;
			margin: 4px;
			border: 1px solid #ddd;
			border-radius: 6px;
		}
		button {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			border: none;
			cursor: pointer;
			transition: all 0.3s ease;
			font-weight: 500;
		}
		button:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(0,0,0,0.3);
		}
		button:disabled {
			background: #6c757d;
			cursor: not-allowed;
			transform: none;
			box-shadow: none;
		}
		.section { 
			margin-bottom: 20px; 
			padding: 20px;
			background: rgba(255, 255, 255, 0.95);
			border-radius: 12px;
			box-shadow: 0 4px 20px rgba(0,0,0,0.1);
			backdrop-filter: blur(10px);
		}
		.glass-panel {
			background: rgba(255, 255, 255, 0.1);
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255, 255, 255, 0.2);
			border-radius: 12px;
			padding: 20px;
			color: white;
		}
		.results-container {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 20px;
			margin-top: 20px;
		}
		.location-panel {
			background: rgba(255, 255, 255, 0.95);
			padding: 20px;
			border-radius: 12px;
			box-shadow: 0 4px 20px rgba(0,0,0,0.1);
		}
		.visualization-panel {
			background: rgba(255, 255, 255, 0.95);
			padding: 20px;
			border-radius: 12px;
			box-shadow: 0 4px 20px rgba(0,0,0,0.1);
		}
		.json-panel {
			background: rgba(255, 255, 255, 0.95);
			padding: 20px;
			border-radius: 12px;
			box-shadow: 0 4px 20px rgba(0,0,0,0.1);
		}
		pre { 
			background: rgba(248, 249, 250, 0.8); 
			padding: 15px; 
			white-space: pre-wrap; 
			border-radius: 6px;
			font-size: 12px;
			max-height: 400px;
			overflow-y: auto;
			border: 1px solid rgba(233, 236, 239, 0.5);
		}
		h1 {
			color: white;
			text-align: center;
			margin-bottom: 30px;
			text-shadow: 0 2px 4px rgba(0,0,0,0.3);
			font-size: 2.5rem;
		}
		h3 {
			color: #495057;
			margin-bottom: 15px;
		}
		.glass-panel h3 {
			color: white;
		}
		label {
			font-weight: 600;
			color: #495057;
			display: block;
			margin-bottom: 5px;
		}
		.glass-panel label {
			color: rgba(255, 255, 255, 0.9);
		}
		.chart-container {
			min-height: 400px;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		.no-chart {
			color: #6c757d;
			font-style: italic;
			text-align: center;
		}
		.location-info {
			background: rgba(40, 167, 69, 0.1);
			border: 1px solid rgba(40, 167, 69, 0.3);
			border-radius: 8px;
			padding: 15px;
			margin: 15px 0;
		}
		.location-status {
			padding: 10px;
			border-radius: 6px;
			margin: 10px 0;
			font-weight: 500;
		}
		.location-success {
			background: rgba(40, 167, 69, 0.1);
			color: #155724;
			border: 1px solid rgba(40, 167, 69, 0.3);
		}
		.location-error {
			background: rgba(220, 53, 69, 0.1);
			color: #721c24;
			border: 1px solid rgba(220, 53, 69, 0.3);
		}
		.location-loading {
			background: rgba(255, 193, 7, 0.1);
			color: #856404;
			border: 1px solid rgba(255, 193, 7, 0.3);
		}
		.quick-queries {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
			gap: 10px;
			margin: 15px 0;
		}
		.quick-query-btn {
			padding: 12px;
			font-size: 13px;
			text-align: left;
			background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
		}
		.location-btn {
			background: linear-gradient(135deg, #fd7e14 0%, #e83e8c 100%);
		}
		.coordinates-display {
			font-family: monospace;
			background: rgba(248, 249, 250, 0.8);
			padding: 8px;
			border-radius: 4px;
			font-size: 12px;
		}
		.location-indicator {
			position: fixed;
			top: 20px;
			right: 20px;
			padding: 8px 12px;
			border-radius: 20px;
			font-size: 12px;
			font-weight: 600;
			z-index: 1000;
			transition: all 0.3s ease;
		}
		.location-active {
			background: rgba(40, 167, 69, 0.9);
			color: white;
			border: 1px solid rgba(40, 167, 69, 1);
		}
		.location-inactive {
			background: rgba(220, 53, 69, 0.9);
			color: white;
			border: 1px solid rgba(220, 53, 69, 1);
		}
		.location-requesting {
			background: rgba(255, 193, 7, 0.9);
			color: #856404;
			border: 1px solid rgba(255, 193, 7, 1);
		}
		@media (max-width: 768px) {
			.results-container {
				grid-template-columns: 1fr;
			}
			.quick-queries {
				grid-template-columns: 1fr;
			}
		}
		.floating-bg {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			z-index: -1;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		}
		.floating-bg::before {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-image: 
				radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
				radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
				radial-gradient(circle at 40% 80%, rgba(120, 119, 198, 0.2) 0%, transparent 50%);
			animation: float 6s ease-in-out infinite;
		}
		@keyframes float {
			0%, 100% { transform: translateY(0px) rotate(0deg); }
			50% { transform: translateY(-20px) rotate(5deg); }
		}
	</style>
</head>
<body>
	<div class="floating-bg"></div>
	<div id="location-indicator" class="location-indicator location-requesting">üìç Getting Location...</div>
	
	<div class="container">
		<h1>üåä Enhanced Groundwater Data Explorer</h1>

		<!-- Location Status Section -->
		<div class="section glass-panel">
			<h3>üìç Location Status</h3>
			<div id="locationStatus" class="location-status location-loading">üì° Automatically detecting your location...</div>
			<div id="coordinatesDisplay" class="coordinates-display" style="display: none;"></div>
		</div>

		<!-- Quick Queries -->
		<div class="section">
			<h3>üöÄ Quick Queries</h3>
			<div class="quick-queries">
				<button class="quick-query-btn" data-query="Show category distribution">üìä Category Distribution</button>
				<button class="quick-query-btn" data-query="Compare rainfall by state">üåß Rainfall by State</button>
				<button class="quick-query-btn" data-query="Show groundwater level trend">üìà Groundwater Trends</button>
				<button class="quick-query-btn" data-query="Compare extraction vs recharge">‚öñ Extraction vs Recharge</button>
				<button class="quick-query-btn" data-query="Show population by state">üë• Population by State</button>
				<button class="quick-query-btn" data-query="Show saline water distribution">üßÇ Saline Distribution</button>
			</div>
		</div>

		<!-- Location-based Queries -->
		<div class="section">
			<h3>üìç Location-based Queries</h3>
			<div class="quick-queries">
				<button class="quick-query-btn location-btn" data-query="What is the groundwater level here?" data-location="true">üíß Groundwater Level Here</button>
				<button class="quick-query-btn location-btn" data-query="What is the rainfall in my area?" data-location="true">üåß Local Rainfall</button>
				<button class="quick-query-btn location-btn" data-query="Is groundwater safe at my location?" data-location="true">‚úÖ Safety Status Here</button>
				<button class="quick-query-btn location-btn" data-query="Show extraction data near me" data-location="true">‚ö° Local Extraction</button>
			</div>
		</div>

		<!-- Query Interface -->
		<div class="section">
			<h3>üí¨ Ask Questions</h3>
			<label>Your Question:</label>
			<input id="question" type="text" 
				   placeholder="e.g., 'What is the groundwater level in Punjab?' or 'Show rainfall trends near me'"
				   style="width: calc(100% - 120px);" />
			<button id="btnQuery">üîé Ask</button>
			<div style="margin-top: 10px; font-size: 12px; color: #6c757d;">
				üí° Try location-based queries like "What's the water quality here?" or "Show data near me"
			</div>
		</div>

		<!-- Configuration -->
		<div class="section">
			<h3>‚öô Configuration</h3>
			<label>API Base URL:</label>
			<input id="baseUrl" type="text" value="http://127.0.0.1:8000" style="width: 100%; max-width: 400px;" />
		</div>

		<!-- Results -->
		<div class="results-container">
			<!-- Location Info Panel -->
			<div class="location-panel">
				<h3>üìç Location Information</h3>
				<div id="location-info">Detecting location...</div>
			</div>

			<!-- Visualization Panel
			<div class="visualization-panel">
				<h3>üìà Data Visualization</h3>
				<div id="chart-container" class="chart-container">
					<div class="no-chart">Ask a question to see visualization</div>
				</div>
			</div>
		</div> -->

		<!-- JSON Output -->
		<div class="section">
			<h3>üóÇ API Response</h3>
			<pre id="json-output">Waiting for data...</pre>
		</div>
	</div>

	<script type="text/babel">
		const { useState, useEffect } = React;
		const { BarChart, Bar, LineChart, Line, PieChart, Pie, Cell, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = (window.Recharts || window.recharts || {});

		const COLORS = ["#0088FE", "#00C49F", "#FFBB28", "#FF8042", "#8884D8", "#82CA9D", "#FF6B6B", "#4ECDC4"];

		// Location state
		let currentLocation = { latitude: null, longitude: null };

		function ChartVisualization({ chart }) {
			if (!chart || !chart.series || chart.series.length === 0) {
				return React.createElement('div', { className: 'no-chart' }, 'No chart data available');
			}

			const renderChart = () => {
				// Handle categorical bar chart with categories
				const hasCategoricalSeries = chart && chart.xAxis && Array.isArray(chart.xAxis.categories) && Array.isArray(chart.series) && chart.series.length > 0;
				if (hasCategoricalSeries) {
					const categories = chart.xAxis.categories;
					const seriesDefs = chart.series;
					const transformedData = categories.map((cat, idx) => {
						const row = { name: cat };
                        seriesDefs.forEach((s, sIdx) => {
                            const key = s.name || `Series ${sIdx + 1}`;
							row[key] = (Array.isArray(s.data) && typeof s.data[idx] === 'number') ? s.data[idx] : 0;
						});
						return row;
					});
					
					return React.createElement(ResponsiveContainer, { width: "100%", height: 400 },
						React.createElement(BarChart, { data: transformedData },
							React.createElement(CartesianGrid, { strokeDasharray: "3 3" }),
							React.createElement(XAxis, { dataKey: "name", angle: -45, textAnchor: "end", height: 80 }),
							React.createElement(YAxis),
							React.createElement(Tooltip),
							React.createElement(Legend),
                            seriesDefs.map((s, idx) => React.createElement(Bar, {
                                key: idx,
                                dataKey: s.name || `Series ${idx + 1}`,
                                fill: (s.color || COLORS[idx % COLORS.length])
                            }))
						)
					);
				}

				const chartData = chart.series[0]?.data || [];

				// Transform data for Recharts
                const transformedData = chartData.map((item, index) => ({
                    name: item.x || item.name || `Item ${index + 1}`,
					value: item.y || item.value || 0,
					...item,
				}));

				switch (chart.type) {
					case "line":
						return React.createElement(ResponsiveContainer, { width: "100%", height: 400 },
							React.createElement(LineChart, { data: transformedData },
								React.createElement(CartesianGrid, { strokeDasharray: "3 3" }),
								React.createElement(XAxis, { dataKey: "name", angle: -45, textAnchor: "end", height: 80 }),
								React.createElement(YAxis),
								React.createElement(Tooltip),
								React.createElement(Legend),
                                chart.series.map((series, index) =>
									React.createElement(Line, {
										key: index,
										type: "monotone",
										dataKey: "value",
										stroke: COLORS[index % COLORS.length],
                                        strokeWidth: 2,
                                        name: series.name || `Series ${index + 1}`
									})
								)
							)
						);

					case "bar":
						return React.createElement(ResponsiveContainer, { width: "100%", height: 400 },
							React.createElement(BarChart, { data: transformedData },
								React.createElement(CartesianGrid, { strokeDasharray: "3 3" }),
								React.createElement(XAxis, { dataKey: "name", angle: -45, textAnchor: "end", height: 80 }),
								React.createElement(YAxis),
								React.createElement(Tooltip),
								React.createElement(Legend),
                                chart.series.map((series, index) =>
									React.createElement(Bar, {
										key: index,
										dataKey: "value",
                                        fill: COLORS[index % COLORS.length],
                                        name: series.name || `Series ${index + 1}`
									})
								)
							)
						);

					case "pie":
						return React.createElement(ResponsiveContainer, { width: "100%", height: 400 },
							React.createElement(PieChart, {},
                                React.createElement(Pie, {
									data: transformedData,
									cx: "50%",
									cy: "50%",
									labelLine: false,
                                    label: ({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`,
									outerRadius: 120,
									fill: "#8884d8",
									dataKey: "value"
								},
                                transformedData.map((entry, index) =>
									React.createElement(Cell, {
                                        key: `cell-${index}`,
										fill: entry.color || COLORS[index % COLORS.length]
									})
								)
								),
							React.createElement(Tooltip),
							React.createElement(Legend)
							)
						);

					default:
                        return React.createElement('div', { 
                            style: { display: 'flex', alignItems: 'center', justifyContent: 'center', height: '160px', color: '#6c757d' } 
                        }, `Unsupported chart type: ${chart.type}`);
				}
			};

			return React.createElement('div', {},
				React.createElement('h4', { style: { marginBottom: '15px', color: '#495057' } }, chart.title || "Data Visualization"),
				renderChart()
			);
		}

		// Main App Component
		function App() {
			const [chartData, setChartData] = useState(null);
			const [jsonData, setJsonData] = useState('Waiting for data...');
			const [locationInfo, setLocationInfo] = useState('Detecting location...');

			const updateDisplay = (data) => {
				// Update JSON display
				setJsonData(typeof data === 'string' ? data : JSON.stringify(data, null, 2));

				// Update location info
				if (data && data.location_info) {
					const locInfo = data.location_info;
					if (locInfo.closest_location) {
                        const closest = locInfo.closest_location;
                        setLocationInfo(`üìç Closest location: ${closest.city}, ${closest.district}, ${closest.state} (${closest.distance_km} km away)\nüéØ Found ${locInfo.locations_found} locations within range`);
					} else {
						setLocationInfo('üìç Location-based query processed');
					}
				} else if (currentLocation.latitude && currentLocation.longitude) {
                    setLocationInfo(`üìç Current location: ${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}`);
				}

				// Handle chart data
				if (data && typeof data === 'object') {
					if (data.chart || data.visualization) {
						setChartData(data.chart || data.visualization);
					}
					else if (Array.isArray(data) && data.length > 0) {
						const firstItem = data[0];
						const keys = Object.keys(firstItem);
						
						if (keys.length >= 2) {
							const xKey = keys[0];
							const yKey = keys.find(k => k !== xKey && !isNaN(parseFloat(firstItem[k]))) || keys[1];
							
                            const chartData = {
                                type: "bar",
                                title: `${yKey} by ${xKey}`,
								series: [{
									name: yKey,
									data: data.map(item => ({
										x: item[xKey],
										y: parseFloat(item[yKey]) || 0,
										name: item[xKey],
										value: parseFloat(item[yKey]) || 0
									}))
								}]
							};
							setChartData(chartData);
						}
					}
					else if (typeof data === 'object' && !Array.isArray(data)) {
						const entries = Object.entries(data).filter(([k, v]) => !isNaN(parseFloat(v)));
						if (entries.length > 0) {
							const chartData = {
								type: "pie",
								title: "Data Distribution",
								series: [{
									name: "Values",
									data: entries.map(([key, value]) => ({
										x: key,
										y: parseFloat(value),
										name: key,
										value: parseFloat(value)
									}))
								}]
							};
							setChartData(chartData);
						}
					}
				}
			};

			useEffect(() => {
				window.updateDisplay = updateDisplay;
			}, []);

			return React.createElement('div', {},
				chartData ? React.createElement(ChartVisualization, { chart: chartData }) 
						  : React.createElement('div', { className: 'no-chart' }, 'Ask a question to see visualization')
			);
		}

		// Render the React app
		const root = ReactDOM.createRoot(document.getElementById('chart-container'));
		root.render(React.createElement(App));
	</script>

	<script>
		const jsonOutput = document.getElementById('json-output');
		const baseUrl = document.getElementById('baseUrl');
		const locationInfo = document.getElementById('location-info');

		function showJson(obj) {
			const jsonString = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
			jsonOutput.textContent = jsonString;
			
			if (window.updateDisplay) {
				window.updateDisplay(obj);
			}
		}

		function updateLocationStatus(message, type = 'info') {
			const statusDiv = document.getElementById('locationStatus');
			const indicator = document.getElementById('location-indicator');
			
            statusDiv.className = `location-status location-${type}`;
			statusDiv.textContent = message;

			// Update indicator
            indicator.className = `location-indicator location-${type === 'success' ? 'active' : type === 'loading' ? 'requesting' : 'inactive'}`;
			
			if (type === 'success') {
				indicator.textContent = 'üìç Location Active';
			} else if (type === 'loading') {
				indicator.textContent = 'üì° Getting Location...';
			} else {
				indicator.textContent = '‚ùå Location Inactive';
			}
		}

		function updateCoordinatesDisplay() {
			const coordsDiv = document.getElementById('coordinatesDisplay');
			if (currentLocation.latitude && currentLocation.longitude) {
                coordsDiv.style.display = 'block';
                coordsDiv.textContent = `üìç Lat: ${currentLocation.latitude.toFixed(6)}, Lng: ${currentLocation.longitude.toFixed(6)}`;
				
				// Update location info display
                locationInfo.textContent = `üìç Current location: ${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}`;
			} else {
				coordsDiv.style.display = 'none';
			}
		}

		// Auto-detect location on page load
		function autoDetectLocation() {
			updateLocationStatus('üì° Automatically detecting your location...', 'loading');

			if (!navigator.geolocation) {
				updateLocationStatus('‚ùå Geolocation not supported by this browser', 'error');
				return;
			}

			navigator.geolocation.getCurrentPosition(
				(position) => {
					currentLocation.latitude = position.coords.latitude;
					currentLocation.longitude = position.coords.longitude;
					
					updateLocationStatus('‚úÖ Location detected and active! Location-based queries will use your current position.', 'success');
					updateCoordinatesDisplay();
				},
				(error) => {
					let errorMessage = '‚ùå Location access denied or failed. Location-based queries will not work.';
					switch(error.code) {
						case error.PERMISSION_DENIED:
							errorMessage = '‚ùå Location access denied by user. Please enable location access for location-based queries.';
							break;
						case error.POSITION_UNAVAILABLE:
							errorMessage = '‚ùå Location information unavailable. Check your device settings.';
							break;
						case error.TIMEOUT:
							errorMessage = '‚ùå Location request timed out. Please refresh the page to try again.';
							break;
					}
					
					updateLocationStatus(errorMessage, 'error');
					locationInfo.textContent = 'Location detection failed. General queries will still work.';
				},
				{
					enableHighAccuracy: true,
					timeout: 10000,
					maximumAge: 300000
				}
			);
		}

		// Watch position for continuous updates
		function startLocationWatching() {
			if (navigator.geolocation) {
				navigator.geolocation.watchPosition(
					(position) => {
						// Only update if position changed significantly (>100m)
						const newLat = position.coords.latitude;
						const newLon = position.coords.longitude;
						
						if (!currentLocation.latitude || 
							Math.abs(currentLocation.latitude - newLat) > 0.001 ||
							Math.abs(currentLocation.longitude - newLon) > 0.001) {
							
							currentLocation.latitude = newLat;
							currentLocation.longitude = newLon;
							updateCoordinatesDisplay();
						}
					},
					(error) => {
						console.log('Location watching error:', error);
					},
					{
						enableHighAccuracy: false,
						timeout: 60000,
						maximumAge: 600000
					}
				);
			}
		}

		async function post(path, body) {
			try {
                const res = await fetch(`${baseUrl.value}${path}`, {
					method: 'POST',
					mode: 'cors',
					credentials: 'omit',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(body)
				});
                if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
				return await res.json();
			} catch (error) {
				return { error: error.message };
			}
		}

		async function queryWithLocation(question) {
			const body = {
				question: question,
				latitude: currentLocation.latitude,
				longitude: currentLocation.longitude
			};

			showJson(await post('/query', body));
		}

		// Event listeners
		document.getElementById('btnQuery').onclick = async () => {
			const question = document.getElementById('question').value;
			if (!question.trim()) {
				showJson({ error: 'Please enter a question' });
				return;
			}
			await queryWithLocation(question);
		};

		// Quick query buttons
		document.addEventListener('DOMContentLoaded', function() {
			// Auto-detect location on page load
			autoDetectLocation();
			
			// Start watching for location changes
			setTimeout(() => {
				startLocationWatching();
			}, 5000); // Start watching after 5 seconds
			
			document.querySelectorAll('.quick-query-btn').forEach(btn => {
				btn.onclick = async () => {
					const query = btn.getAttribute('data-query');
					const isLocationQuery = btn.getAttribute('data-location') === 'true';
					
					if (isLocationQuery && (!currentLocation.latitude || !currentLocation.longitude)) {
						showJson({ 
							error: 'Location not available for location-based query. Please enable location access.',
							suggestion: 'This query requires your location. Please allow location access when prompted.'
						});
						return;
					}
					
					document.getElementById('question').value = query;
					await queryWithLocation(query);
				};
			});
		});

		// Enter key support
		document.getElementById('question').addEventListener('keypress', function(e) {
			if (e.key === 'Enter') {
				document.getElementById('btnQuery').click();
			}
		});
	</script>
</body>
</html>